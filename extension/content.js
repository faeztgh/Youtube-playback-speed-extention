import{j as h,S as j,P as I,g as M,o as N,a as K,r as d,D as p,s as B}from"./chunks/PresetList-CE6TDJkt.js";import{o as D,s as x}from"./chunks/messaging-LSX-IhiR.js";const H=[.25,.5,.75,1,1.25,1.5,1.75,2];function V(e){const t=H,n=Math.min(t[t.length-1],Math.max(t[0],e));return t.reduce((a,o)=>Math.abs(o-n)<Math.abs(a-n)?o:a,t[0])}function g(){const e=document.querySelector("video.html5-main-video");return e&&!Number.isNaN(e.playbackRate)?e:document.querySelector("video")}function S(e){return e.__reverseController??null}function _(e,t){e.__reverseController=t}function E(e){const t=S(e);t!=null&&t.rafId&&cancelAnimationFrame(t.rafId),_(e,null)}function F(e,t){E(e);const n={rafId:null,lastTimestampMs:null,speedAbs:t};_(e,n);try{e.pause()}catch{}const a=o=>{if(!document.contains(e)){E(e);return}const i=S(e);if(!i)return;const c=i.lastTimestampMs??o,f=Math.min(.25,Math.max(0,(o-c)/1e3));i.lastTimestampMs=o;const s=f*i.speedAbs,u=Math.max(0,e.currentTime-s);e.currentTime=u,i.rafId=requestAnimationFrame(a)};n.rafId=requestAnimationFrame(a)}function m(e){const t=g();if(!t)return!1;if(e<0){const a=Math.abs(e);return t.playbackRate=0,F(t,a),t.dispatchEvent(new Event("ratechange")),!0}E(t);const n=V(e);return t.playbackRate=n,t.dispatchEvent(new Event("ratechange")),!0}function b(){const e=g();if(!e)return null;const t=S(e);return t?-t.speedAbs:e.playbackRate}function U(e){if(g()){e();return}const t=new MutationObserver(()=>{g()&&(t.disconnect(),e())});t.observe(document.documentElement,{childList:!0,subtree:!0})}const W=({currentRate:e,onChange:t,presets:n,rightPx:a,bottomPx:o,opacity:i,visible:c,autoHide:f})=>c?h.jsx("div",{className:"fixed z-[2147483647] font-sans transition-opacity "+(f?"opacity-0 hover:opacity-100":""),style:{right:a,bottom:o},children:h.jsxs("div",{className:"text-white border border-neutral-700 rounded-xl p-2.5 shadow-2xl backdrop-blur-sm",style:{background:"rgba(0,0,0,0.90)",opacity:i},children:[h.jsx(j,{label:"Speed",min:.1,max:4,value:e,onChange:t,className:"",valueClassName:"!w-auto min-w-[48px]"}),h.jsx(I,{presets:n,onSelect:t,className:"mt-2"})]})}):null;function z(){const e=document.querySelector('meta[property="og:title"]');return e!=null&&e.content?e.content:document.title||""}function G(){const e=document.querySelector("ytd-channel-name")||document.querySelector("#channel-name");if(e)return e.innerText.trim();const t=Array.from(document.querySelectorAll("a")).find(n=>{var a,o;return((a=n.getAttribute("href"))==null?void 0:a.startsWith("/@"))||((o=n.getAttribute("href"))==null?void 0:o.startsWith("/channel/"))});return((t==null?void 0:t.textContent)||"").trim()}function J(e){const t=e.pattern.toLowerCase();return t?e.type==="title"?z().toLowerCase().includes(t):e.type==="channel"?G().toLowerCase().includes(t):location.href.toLowerCase().includes(t):!1}function Q(){const e=document.createElement("div");document.documentElement.appendChild(e);const t=K(e),n=()=>{const[a,o]=d.useState(b()??p.defaultPlaybackRate),[i,c]=d.useState(p.customRates),[f,s]=d.useState(p.showOverlay),[u,y]=d.useState(p.overlay.position.rightPx),[O,A]=d.useState(p.overlay.position.bottomPx),[q,P]=d.useState(p.overlay.opacity),[Y,w]=d.useState(p.overlay.autoHide);return d.useEffect(()=>(M().then(r=>{c(r.customRates),s(r.overlay.visible||r.showOverlay),y(r.overlay.position.rightPx),A(r.overlay.position.bottomPx),P(r.overlay.opacity),w(r.overlay.autoHide)}),N(r=>{c(r.customRates),s(r.overlay.visible||r.showOverlay),y(r.overlay.position.rightPx),A(r.overlay.position.bottomPx),P(r.overlay.opacity),w(r.overlay.autoHide)})),[]),d.useEffect(()=>{const v=()=>{const l=document.querySelector("video.html5-main-video");return l&&!Number.isNaN(l.playbackRate)?l:document.querySelector("video")};let r=null;const R=()=>{const l=b();l!==null&&(o(l),x({type:"CURRENT_PLAYBACK_RATE",rate:l}),B({defaultPlaybackRate:l}))},T=()=>{const l=v();!l||l===r||(r&&r.removeEventListener("ratechange",R,!0),r=l,r.addEventListener("ratechange",R,!0),R())};T();const k=new MutationObserver(()=>T());return k.observe(document.documentElement,{childList:!0,subtree:!0}),()=>{r&&r.removeEventListener("ratechange",R,!0),k.disconnect()}},[]),h.jsx(W,{currentRate:a,presets:i,onChange:v=>m(v),rightPx:u,bottomPx:O,opacity:q,visible:f,autoHide:Y})};t.render(h.jsx(n,{}))}async function C(e){for(const t of e.rules)try{if(J(t)){m(t.speed);break}}catch{}}function L(e){const t=n=>{const a=n.target;if(a){const s=a.tagName.toLowerCase(),u=a.isContentEditable;if(s==="input"||s==="textarea"||u)return}const o=b()??1,i=e.stepSize,c=e.customRates.slice().sort((s,u)=>s-u),f=s=>!e.snapToPreset||c.length===0?s:c.reduce((u,y)=>Math.abs(y-s)<Math.abs(u-s)?y:u,c[0]);if(n.key===e.shortcuts.increase){const s=f(o+i);m(s)}else if(n.key===e.shortcuts.decrease){const s=f(Math.max(.1,o-i));m(s)}else if(n.key===e.shortcuts.reset)m(e.defaultPlaybackRate);else if(n.key===e.shortcuts.cycle){if(c.length>0){const s=c.findIndex(y=>Math.abs(y-o)<1e-6),u=s>=0?c[(s+1)%c.length]:c[0];m(u)}}else return;n.preventDefault(),n.stopPropagation()};return window.addEventListener("keydown",t,!0),()=>window.removeEventListener("keydown",t,!0)}async function X(){let e=await M();U(()=>{Q(),e.defaultPlaybackRate&&e.defaultPlaybackRate!==1&&m(e.defaultPlaybackRate),C(e);let t=L(e),n=JSON.stringify(e.rules);N(o=>{e=o;const i=JSON.stringify(o.rules);i!==n&&(n=i,C(o)),t(),t=L(o)});const a=b();a!==null&&x({type:"CURRENT_PLAYBACK_RATE",rate:a})}),D(t=>{if(t.type==="SET_PLAYBACK_RATE")m(t.rate);else if(t.type==="GET_PLAYBACK_RATE"){const n=b();n!==null&&x({type:"CURRENT_PLAYBACK_RATE",rate:n})}})}X();
